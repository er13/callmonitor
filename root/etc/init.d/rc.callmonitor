#!/bin/sh

PATH=/bin:/usr/bin:/sbin:/usr/sbin:/mod/usr/bin:/mod/usr/sbin
DAEMON=callmonitor

case "$1" in
	""|start|restart)
		if [ ! -r "/mod/etc/conf/$DAEMON.cfg" ]; then
			echo "Error[$DAEMON]: not configured" 1>&2
			exit 1
		fi

		. "/mod/etc/default.callmonitor/system.cfg"
		. "/mod/etc/conf/$DAEMON.cfg"

		TELEFON="$CALLMONITOR_LIBDIR/bin/telefon"
		;;
esac

start() {
	echo -n "Starting call monitor..."
	if [ ! -e /mod/etc/callmonitor.listeners ]; then
		ln -sf "$CALLMONITOR_LISTENERS" /mod/etc/callmonitor.listeners
	fi

	killall telefon > /dev/null 2>&1
	"$TELEFON" -f a127.0.0.1 > /dev/null
	exitval=$?
	if [ "$exitval" -eq 0 ]; then
		echo "done."
	else
		echo "failed."
		exit $exitval
	fi
}

stop() {
	echo -n "Stopping call monitor..."
	killall telefon callmonitor > /dev/null 2>&1
	exitval=$?
	if [ "$exitval" -eq 0 ]; then
		echo "done."
	else
		echo "failed."
		exit $exitval
	fi
}

case "$1" in
	"")
		if [ "$CALLMONITOR_ENABLED" != "yes" ]; then
			echo "$DAEMON is disabled" 1>&2
			exit 1;
		fi

		start
		;;
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		sleep 1
		start
		;;
	status)
		if [ -z "`pidof $DAEMON`" ]; then
			echo "stopped"
		else
			echo "running"
		fi
		;;
	*)
		echo "Usage: $0 [start|stop|restart|status]" 1>&2
		exit 1
		;;
esac

exit 0
